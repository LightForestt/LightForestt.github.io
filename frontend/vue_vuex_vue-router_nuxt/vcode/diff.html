<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title> learning 🤔</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="ing">
    
    <link rel="preload" href="/assets/css/0.styles.e4d8b86b.css" as="style"><link rel="preload" href="/assets/js/app.8a3e4be4.js" as="script"><link rel="preload" href="/assets/js/2.b1c453a7.js" as="script"><link rel="preload" href="/assets/js/48.9a81b491.js" as="script"><link rel="prefetch" href="/assets/js/10.a1484098.js"><link rel="prefetch" href="/assets/js/11.b70f6910.js"><link rel="prefetch" href="/assets/js/12.aa4e4756.js"><link rel="prefetch" href="/assets/js/13.24822fb7.js"><link rel="prefetch" href="/assets/js/14.ba83d711.js"><link rel="prefetch" href="/assets/js/15.ce56a167.js"><link rel="prefetch" href="/assets/js/16.510d6dca.js"><link rel="prefetch" href="/assets/js/17.41412f1e.js"><link rel="prefetch" href="/assets/js/18.8143a9b6.js"><link rel="prefetch" href="/assets/js/19.dfc55bfb.js"><link rel="prefetch" href="/assets/js/20.d149cd7c.js"><link rel="prefetch" href="/assets/js/21.282166c1.js"><link rel="prefetch" href="/assets/js/22.c878d45b.js"><link rel="prefetch" href="/assets/js/23.7ea9cee2.js"><link rel="prefetch" href="/assets/js/24.0a65f294.js"><link rel="prefetch" href="/assets/js/25.cf952e8f.js"><link rel="prefetch" href="/assets/js/26.fa6a6b52.js"><link rel="prefetch" href="/assets/js/27.986b9955.js"><link rel="prefetch" href="/assets/js/28.cd904e4d.js"><link rel="prefetch" href="/assets/js/29.22c8bd30.js"><link rel="prefetch" href="/assets/js/3.0b8b26d0.js"><link rel="prefetch" href="/assets/js/30.f974ab27.js"><link rel="prefetch" href="/assets/js/31.c099b303.js"><link rel="prefetch" href="/assets/js/32.eb8d6a86.js"><link rel="prefetch" href="/assets/js/33.77cf9e9a.js"><link rel="prefetch" href="/assets/js/34.67e1bc26.js"><link rel="prefetch" href="/assets/js/35.acda1906.js"><link rel="prefetch" href="/assets/js/36.8f514314.js"><link rel="prefetch" href="/assets/js/37.75d78737.js"><link rel="prefetch" href="/assets/js/38.e372ed82.js"><link rel="prefetch" href="/assets/js/39.31d074d8.js"><link rel="prefetch" href="/assets/js/4.e7c996f5.js"><link rel="prefetch" href="/assets/js/40.a0159801.js"><link rel="prefetch" href="/assets/js/41.633bb894.js"><link rel="prefetch" href="/assets/js/42.2ef5b25c.js"><link rel="prefetch" href="/assets/js/43.f3f083c8.js"><link rel="prefetch" href="/assets/js/44.e18663a3.js"><link rel="prefetch" href="/assets/js/45.0853c943.js"><link rel="prefetch" href="/assets/js/46.bb71b1df.js"><link rel="prefetch" href="/assets/js/47.806d670b.js"><link rel="prefetch" href="/assets/js/49.cc728521.js"><link rel="prefetch" href="/assets/js/5.6eff8140.js"><link rel="prefetch" href="/assets/js/50.64a8e83d.js"><link rel="prefetch" href="/assets/js/51.9125457b.js"><link rel="prefetch" href="/assets/js/52.17eb17a0.js"><link rel="prefetch" href="/assets/js/6.17d5dd20.js"><link rel="prefetch" href="/assets/js/7.576da1bf.js"><link rel="prefetch" href="/assets/js/8.6fffe5ac.js"><link rel="prefetch" href="/assets/js/9.6ab3dd2a.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e4d8b86b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name"> learning 🤔</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>frontend</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>javascript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>html</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>css</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>browser</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>typescript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>nodejs</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>vuejs</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/frontend/vue_vuex_vue-router_nuxt/vcode/1.html" class="sidebar-link">new vue()之前都发生了什么？（一）</a></li><li><a href="/frontend/vue_vuex_vue-router_nuxt/vcode/2.html" class="sidebar-link">new Vue(options) 中的options合并处理（二）</a></li><li><a href="/frontend/vue_vuex_vue-router_nuxt/vcode/3.html" class="sidebar-link">在new Vue(options)中是如何为options进行初始化（三）</a></li><li><a href="/frontend/vue_vuex_vue-router_nuxt/vcode/4.html" class="sidebar-link">initState与响应式原理（四）</a></li><li><a href="/frontend/vue_vuex_vue-router_nuxt/vcode/5.html" class="sidebar-link">从$mount到虚拟dom（五）</a></li><li><a href="/frontend/vue_vuex_vue-router_nuxt/vcode/diff.html" aria-current="page" class="active sidebar-link">diff 源码 注释版</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>threejs</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>backend</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>basic</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">updateChildren</span><span class="token punctuation">(</span>
  <span class="token parameter">parentElm<span class="token punctuation">,</span>
  oldCh<span class="token punctuation">,</span>
  newCh<span class="token punctuation">,</span>
  insertedVnodeQueue<span class="token punctuation">,</span>
  removeOnly</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> oldStartIdx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> newStartIdx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> oldEndIdx <span class="token operator">=</span> oldCh<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> oldStartVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> oldEndVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span>oldEndIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> newEndIdx <span class="token operator">=</span> newCh<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> newEndVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span>newEndIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> oldKeyToIdx<span class="token punctuation">,</span> idxInOld<span class="token punctuation">,</span> vnodeToMove<span class="token punctuation">,</span> refElm<span class="token punctuation">;</span>

  <span class="token comment">// removeOnly is a special flag used only by &lt;transition-group&gt;</span>
  <span class="token comment">// to ensure removed elements stay in correct relative positions</span>
  <span class="token comment">// during leaving transitions</span>
  <span class="token keyword">var</span> canMove <span class="token operator">=</span> <span class="token operator">!</span>removeOnly<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">&quot;production&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">checkDuplicateKeys</span><span class="token punctuation">(</span>newCh<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
     * 
     * 整个diff过程是一个不断while循环的过程 在循环过程中通过不同的case进行判断 
     * 通过不同情况的判断选择出最优的节点移动方式
     * 每经过一个while循环 old/new start idx++，相反的 old/new end idx --
     * 当oldStartIdx &lt;= oldEndIdx &amp;&amp; newStartIdx &lt;= newEndIdx的情况下会不断的进行while循环进行diff操作节点位置操作
     * 在整个diff过程中 是同级比较的 没有跨层级进行diff 比较的vnode的父节点是同一个。
     
          +--&gt;                                       &lt;--+

      old start idx                                old end idx
          +----+         +----+         +----+       +----+
          |    |         |    |         |    |       |    |
          |    |         |    |         |    |       |    |
          +----+         +----+         +----+       +----+


          +----+         +----+         +----+       +----+       +----+
          |    |         |    |         |    |       |    |       |    |
          |    |         |    |         |    |       |    |       |    |
          +----+         +----+         +----+       +----+       +----+
      new start idx                                             new end idx

           +--&gt;                                                    &lt;--+

     */</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>oldStartIdx <span class="token operator">&lt;=</span> oldEndIdx <span class="token operator">&amp;&amp;</span> newStartIdx <span class="token operator">&lt;=</span> newEndIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// case 1 ： 旧的列表中 oldstartvnode不存在 直接 ++ 后移一位</span>
      oldStartVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">++</span>oldStartIdx<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// Vnode has been moved left</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// case 2 : 旧的列表中 oldendvnode不存在 直接 -- 前移一位</span>
      oldEndVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">--</span>oldEndIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// case 3 ：判断新旧start vnode是不是相同的 如果是相同的 直接对这两个相同的vnode进行陈层的patchVnode操作</span>
      <span class="token function">patchVnode</span><span class="token punctuation">(</span>
        oldStartVnode<span class="token punctuation">,</span>
        newStartVnode<span class="token punctuation">,</span>
        insertedVnodeQueue<span class="token punctuation">,</span>
        newCh<span class="token punctuation">,</span>
        newStartIdx
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      oldStartVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">++</span>oldStartIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
      newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span> newEndVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// case 4 ： 如果 旧end 和 新end相同 ，对这两个节点进行深度的patchVnode操作</span>
      <span class="token function">patchVnode</span><span class="token punctuation">(</span>
        oldEndVnode<span class="token punctuation">,</span>
        newEndVnode<span class="token punctuation">,</span>
        insertedVnodeQueue<span class="token punctuation">,</span>
        newCh<span class="token punctuation">,</span>
        newEndIdx
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      oldEndVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">--</span>oldEndIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
      newEndVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">--</span>newEndIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span> newEndVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// case 5 :如果旧start和新end是相同的节点 第一步对这两个节点进行深层的patchvnode， 把子节点都patch完毕，第二步把旧start插入到旧end后边 也就是和新vnode保持一致</span>
      <span class="token function">patchVnode</span><span class="token punctuation">(</span>
        oldStartVnode<span class="token punctuation">,</span>
        newEndVnode<span class="token punctuation">,</span>
        insertedVnodeQueue<span class="token punctuation">,</span>
        newCh<span class="token punctuation">,</span>
        newEndIdx
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      canMove <span class="token operator">&amp;&amp;</span>
        nodeOps<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>
          parentElm<span class="token punctuation">,</span>
          oldStartVnode<span class="token punctuation">.</span>elm<span class="token punctuation">,</span>
          nodeOps<span class="token punctuation">.</span><span class="token function">nextSibling</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">.</span>elm<span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      oldStartVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">++</span>oldStartIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
      newEndVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">--</span>newEndIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// case 6 ：如果旧end和新start相同 第一步：深层patch 第二步：把旧end添加到旧start前边</span>
      <span class="token function">patchVnode</span><span class="token punctuation">(</span>
        oldEndVnode<span class="token punctuation">,</span>
        newStartVnode<span class="token punctuation">,</span>
        insertedVnodeQueue<span class="token punctuation">,</span>
        newCh<span class="token punctuation">,</span>
        newStartIdx
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      canMove <span class="token operator">&amp;&amp;</span>
        nodeOps<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> oldEndVnode<span class="token punctuation">.</span>elm<span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm<span class="token punctuation">)</span><span class="token punctuation">;</span>
      oldEndVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">--</span>oldEndIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
      newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// case 7 ： 在不满足上述情况下 又分为2种子情况</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>oldKeyToIdx<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 在oldkeytoidx不存在的情况下去构建一个哈希表</span>
        oldKeyToIdx <span class="token operator">=</span> <span class="token function">createKeyToOldIdx</span><span class="token punctuation">(</span>oldCh<span class="token punctuation">,</span> oldStartIdx<span class="token punctuation">,</span> oldEndIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      idxInOld <span class="token operator">=</span> <span class="token function">isDef</span><span class="token punctuation">(</span>newStartVnode<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token comment">// 判断当前新start的key存不存在</span>
        <span class="token operator">?</span> oldKeyToIdx<span class="token punctuation">[</span>newStartVnode<span class="token punctuation">.</span>key<span class="token punctuation">]</span> <span class="token comment">//  如果存在 就去旧哈希表中寻找</span>
        <span class="token operator">:</span> <span class="token function">findIdxInOld</span><span class="token punctuation">(</span>newStartVnode<span class="token punctuation">,</span> oldCh<span class="token punctuation">,</span> oldStartIdx<span class="token punctuation">,</span> oldEndIdx<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 否则通过samenode去查找</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>idxInOld<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 在通过寻找过后 没有在旧的vnode列表中查找到新的vnode节点 迫不得已 去创建dom元素并插入到到dom树中</span>
        <span class="token function">createElm</span><span class="token punctuation">(</span>
          newStartVnode<span class="token punctuation">,</span>
          insertedVnodeQueue<span class="token punctuation">,</span>
          parentElm<span class="token punctuation">,</span>
          oldStartVnode<span class="token punctuation">.</span>elm<span class="token punctuation">,</span>
          <span class="token boolean">false</span><span class="token punctuation">,</span>
          newCh<span class="token punctuation">,</span>
          newStartIdx
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        vnodeToMove <span class="token operator">=</span> oldCh<span class="token punctuation">[</span>idxInOld<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 拿到需要移动的vnode节点</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>vnodeToMove<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 判断是不是相同的vnode节点 （不存在同为undefined的情况 因为已经在find的过程中对同为undefined的情况进行了判断 这里针对两个vnode虽然key相同 但实际上不是严格相同的vnode进行筛选）</span>
          <span class="token function">patchVnode</span><span class="token punctuation">(</span>
            vnodeToMove<span class="token punctuation">,</span>
            newStartVnode<span class="token punctuation">,</span>
            insertedVnodeQueue<span class="token punctuation">,</span>
            newCh<span class="token punctuation">,</span>
            newStartIdx
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
          oldCh<span class="token punctuation">[</span>idxInOld<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
          <span class="token comment">// 在每次插入的过程中都是在通过旧vnode的元素进行定位和插入 以保证最小改动 这里直接把当前找到的vnode插入到旧start（其实不一定是start 因为idx一直在变）前边</span>
          canMove <span class="token operator">&amp;&amp;</span>
            nodeOps<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> vnodeToMove<span class="token punctuation">.</span>elm<span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token comment">//虽然通过key找到了旧vnode 数组中对应的当前元素 但是这两个vnode并不是严格相等的 所以直接按照未找到当前节点的策略进行 去创建一个新的节点 无法通过节点的移动去提高性能</span>
          <span class="token comment">// same key but different element. treat as new element</span>
          <span class="token function">createElm</span><span class="token punctuation">(</span>
            newStartVnode<span class="token punctuation">,</span>
            insertedVnodeQueue<span class="token punctuation">,</span>
            parentElm<span class="token punctuation">,</span>
            oldStartVnode<span class="token punctuation">.</span>elm<span class="token punctuation">,</span>
            <span class="token boolean">false</span><span class="token punctuation">,</span>
            newCh<span class="token punctuation">,</span>
            newStartIdx
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//当前新节点已经插入了 ++</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>oldStartIdx <span class="token operator">&gt;</span> oldEndIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 这个case下 代表 旧节点比新节点少 就需要添加新节点进去</span>
    refElm <span class="token operator">=</span> <span class="token function">isUndef</span><span class="token punctuation">(</span>newCh<span class="token punctuation">[</span>newEndIdx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> newCh<span class="token punctuation">[</span>newEndIdx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>elm<span class="token punctuation">;</span> <span class="token comment">// 确定插入位置</span>
    <span class="token function">addVnodes</span><span class="token punctuation">(</span>
      parentElm<span class="token punctuation">,</span>
      refElm<span class="token punctuation">,</span>
      newCh<span class="token punctuation">,</span>
      newStartIdx<span class="token punctuation">,</span>
      newEndIdx<span class="token punctuation">,</span>
      insertedVnodeQueue
    <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 遍历插入</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>newStartIdx <span class="token operator">&gt;</span> newEndIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 代表新节点比旧节点少 去删除就节点中不想要的节点</span>
    <span class="token function">removeVnodes</span><span class="token punctuation">(</span>oldCh<span class="token punctuation">,</span> oldStartIdx<span class="token punctuation">,</span> oldEndIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/frontend/vue_vuex_vue-router_nuxt/vcode/5.html" class="prev">
        从$mount到虚拟dom（五）
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.8a3e4be4.js" defer></script><script src="/assets/js/2.b1c453a7.js" defer></script><script src="/assets/js/48.9a81b491.js" defer></script>
  </body>
</html>
